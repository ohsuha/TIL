# 웹 애플리케이션과 싱글톤
## 왜 싱글톤 패턴을 사용하는가?
- 기업용 온라인 서비스를 지원하기 위해 탄생했다. 대부분의 스프링 애플리케이션은 웹 애플리케이션이고 보통 여러 고객이 동시에 요청을 한다.
- 동시에 여러 클라이언트가 요청하면 DI 컨테이너는 객체를 new 로 생성해서 처리한다. 그러면 요청이 올때마다 객체를 생성해야한다.
- 요청이 5만개가 들어오면 5만개의 객체를 생성하고 소멸시켜야한다. : 메모리 낭비가 심하다.
- 해결방안으로 해당 객체를 딱 1개만 생성시키고 공유해 사용하도록 하면 된다.
- 싱글톤 빈은 애플리케이션 전역에서 상태를 유지하고 여러 컴포넌트에서 동일한 데이터를 공유할 수 있도록 돕는다. 리소스나 설정과 같은 공통 데이터를 관리하는 데 유용하다.
- 때문에 싱글톤으로 관리되는 빈은 상태를 가지지 않는 설계가 권장된다. 상태를 가지면 여러 스레드가 동시에 접근할 때 문제가 발생할 수 있다.

## 싱글톤 패턴의 문제점
- 코드 자체가 많이 들어간다.
- 의존 관계상 구체 클래스에 의존한다. DIP 를 위반한다.
- 클라이언트가 구체 클래스에 의존해서 OCP를 위반한다.
- 테스트하기 어렵다
- 내부 속성을 변경하거나 촞기화 하기 어렵다.
- private 생성자로 자식 클래스를 만들기 어렵다.
- 유연성이 떨어진다.

## 스프링에서 싱글톤의 문제를 어떻게 해결했나?
- 스프링 빈은 싱글톤으로 관리되는데, 패턴을 적용하지 않아도 객체 인스턴스를 싱글톤으로 관리한다.
- 스프링 컨테이너는 싱글톤 컨테이너 역할을 한다. 이렇게 싱글톤 객체를 생성하고 관리하는 기능을 싱글톤 레지스트리라한다.
- 스프링 컨테이너의 기능 덕분에 싱글턴 패턴의 단점을 해결하면서 객체를 싱글턴으로 유지할 수 있다.
  - 싱글톤 패턴을 위한 추가 코드 필요없음
  - DIP, OCP, 테스트, private 생성자로부터 자유롭게 싱글톤을 사용할 수 있다.
- 고객의 요청이 올 때마다 객체를 생성하는 것이 아니라, 이미 만들어진 객체를 공유해서 효율적으로 재사용할 수 있다.
- 빈 스코프 기능을 통해 싱글톤 외의 다른 방식의 객체도 생성할 수 있다.

## 싱글톤 방식의 주의점
- 객체를 하나만 생성해서 공유하는 방식은 여러 클라이언트가 하나의 객체 인스턴스를 공유하기 때문에 상태를 유지하게 설계하면 안된다.
- 특정 클라이언트에 의존적인 필드, 값을 변경할 수 있으면 안된다.
- 스프링 빈의 필드에 공유 값을 설정하면 정말 큰 장애가 발생할 수 있다.
- 스프링은 항상 stateless 로 설계해야한다.

## @Configuration
- 싱글톤을 위해 존재한다.
- @Bean 이 되어있는데 한 클래스를 여러곳에서 의존하면 그때마다 new Class() 를 호출 하면 싱글톤이 깨지는게 아닌가? 어떻게 똑같은가?
- @Configuration 을 적용하면 이것도 스프링 빈으로 등록이 된다. 뒤에 CGLIB 이 붙는 클래스가 만들어진다.
- 스프링은 바이트 코드를 조작하여 CGLIB 라이브러리를 사용해서 @Configuration 을 상속받은 임의의 다른 클래스를 만든다.
- 임의의 다른 클래스에서 @Bean 이 붙은 메서드마다 이미 스프링 빈이 존재하면 존재하는 빈을 반환하고 없으면 등록하도록 반환하는 코드를 동적으로 만들어 싱글톤을 보장시킨다.
- @Configuration 이 없으면 내부에 있는 @Bean 의 싱글톤을 보장할 수 없어진다.