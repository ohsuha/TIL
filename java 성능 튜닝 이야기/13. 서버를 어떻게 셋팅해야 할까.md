# 셋팅해야할 부분
- 웹서버
- WAS
- DB 서버
- 장비

## 아파치 웹서버 설정
- 웹서버는 반드시 WAS 보다 앞에 둔다.
- 아파치 웹서버는 MPM을 만든다. MPM은 웹 서버의 프로세스와 스레드를 관리하는 방식을 결정하는 중요한 모듈
- httpd.conf 파일을 통해 스레드의 개수를 지정할 수 있다.
  - ThreadPerChild : 웹서버의 스레드 수
  - MaxRequestPerChild : 최대 요청 개수
- 스레드 동작 방식의 수정은 httpd-mpm.conf 를 통해 수정
  - MaxClients : 최대 처리가능한 클라이언트의 수,최대 클라수를 넘으면 서버 리소스에 여유가 있어도 처리를 하지 않는다.
  - Apache 2.4부터는 MaxClients라는 설정이 **MaxRequestWorkers**로 변경되었습니다. 이전 버전에서 MaxClients는 동시에 처리할 수 있는 최대 클라이언트(요청) 수를 설정하는 항목이었지만, 2.4 이후부터는 MaxRequestWorkers로 이름이 바뀌었으며 동일한 역할을 합니다.
  ```
    <IfModule mpm_worker_module>
    StartServers        3        # 시작 시 생성할 프로세스 수
    MinSpareThreads     75       # 유휴 상태에서 유지할 최소 스레드 수
    MaxSpareThreads     250      # 유휴 상태에서 유지할 최대 스레드 수
    ThreadLimit         64       # 각 프로세스가 생성할 수 있는 최대 스레드 수
    ThreadsPerChild     25       # 각 프로세스가 실행할 스레드 수
    MaxRequestWorkers   400      # 동시에 처리할 수 있는 최대 요청 수
    MaxConnectionsPerChild 0     # 각 프로세스가 처리할 수 있는 최대 연결 수 (0은 무제한)
    </IfModule>
  ```
- http.conf 에 keepAlive on 을 추가
  - 웹서버가 웹브라우저와 연결이 되었을 때 keepAlive 가 켜져있지 않으면 매번 HTTP 와 연결을 끊었다 맺었다 한다.
  - 이게 켜져 있으면 클라와의 서버 연결이 끊기지 않고 일정시간 동안 유지된다.
  - 클라가 추가 요청을 보낼때 새로 연결을 설정할 필요가 없다.
  - HTML, CSS, JS 등 여러개의 리소스 요청시 각 요청마다 새로운 연결을 설정하는 대신 기존의 연결을 재사용할 수 있다.
  - 시간 설정도 할 수 있는데, 사용자가 너무 많으면 5초 정도로 짧게 유지하는것도 효율적으로 사용할 수 있는 방법이다.

## WAS 의 인스턴스 갯수 설정
- 마구 늘리면 CPU 처리량이 늘어난다. 코어가 많다고 많이 띄우는것이 아니다.
- 코어하나당 1~2개의 인스턴스가 기본이지만 TPS 를 측정하고 성능이 드라마틱하게 좋아지는 구간정도만 추가해야한다.
- 인스턴스 개수가 많을수록 배포, 모니터링이 어려워진다.
- WAS 장비에 메모리가 4기가라고 인스턴스도 4기가로 하면 FullGC 가 돌때 4기가를 다 돌아야해서 시간이 많이 소요될 수 있다. 512MB ~ 2GB 정도가 적당하다.
- 장비가 한대여도 두개 이상의 인스턴스가 서로 클러스터링 하도록 지정해서 사용자의 세션정보를 공유하도록 하는것이 좋다.

### 세션?
웹 애플리케이션에서 사용자가 웹서버에 접속하느 동안 지속되는 대화상태를 의미한다. 사용자가 웹사이트에서 활동하는 동안의 정보를 저장하는 일종의 메모리이다.
웹 애플리케이션에서 처음 접속하면 서버는 새로운 세션을 생성하고 고유 세션 ID 를 할당한다. 이 ID는 사용자가 서버에 요청할때마다 함께 전송된다.
세션 정보는 HTTP쿠키를 통해 클라이언트에게 전달된다. 클라가 이 쿠키를 서버에 보내서 세션을 식별할 수 있다.
일반적인 서버의 경우 세션 종료시간을 4분정도로 설정한다.

여러 WAS 인스턴스가 클러스터링 되어있을때 세션 정보를 공유할 수 있다.
WAS 는 세션데이터를 저장소나 캐시에 저장해 각 인스턴스가 동일한 세션정보에 접근하게 한다.

## DB Connection
- 운영중에는 커넥션의 최대, 최소값을 동일하게 하는 것이 좋다. 사용자 수가 갑자기 늘어나면 풀 개수가 증가되어야하는데, 증가할때 대기시간도 발생하기 때문이다.
- DB 커넥션풀은 보통 40~50개, 스레드는 이보다 10개정도 더 많게 지정하는게 보통이다.
- 스레드의 개수가 적으면 커넥션 풀이 필요 없이 놀고 있기 때문이다. 모든 애플리케이션이나 화면이 DB에 접속하는 것도 아니고 관리자 콘솔을통해 서버에 접속할 수 있기 때문에 여유분을 가지고 지정해준다.
- DB CPU 가 100% 라면 쿼리를 튜닝, DB CPU 가 40% 인데 WAS CPU 가 100% 라면 WAS 를 튜닝하고 그래도 안되면 커넥션 풀을 5~10개정도 늘리는 방식을 추천한다.
- 풀을 찾기 위해 대기시간을 주는데 기본은 20초로 셋팅되어있다.
  - DB 연결을 못해 기다리는 사용자가 20초를 기다려야한다는 뜻이다.
  - 하지만 너무 짧으면 FullGC(300ms 보다 줄이기 어렵다) 가 발생하는 순간 대기중인 모든 스레드가 연결을 못했다고 time out 이 발생하므로 적당히 설정하자.
